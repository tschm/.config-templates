# This file is part of the tschm/.config-templates repository
# (https://github.com/tschm/.config-templates).
#
# Devcontainer CI Workflow
#
# This workflow validates that the devcontainer image builds successfully
# when devcontainer-related files are changed. It does NOT publish the image.
#
# Publishing only happens during releases via the release.yml workflow when
# PUBLISH_DEVCONTAINER is set to true.

name: DEVCONTAINER

on:
  push:
    branches:
      - '**'
    paths:
      - ".devcontainer/**"
      - ".github/workflows/devcontainer.yml"

  pull_request:
    branches: [ main, master ]  
    paths:
      - ".devcontainer/**"
      - ".github/workflows/devcontainer.yml"

permissions:
  contents: read
  packages: write

jobs:
  build:
    name: Build Devcontainer Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set registry
        id: registry
        run: |
          REGISTRY="${{ vars.DEVCONTAINER_REGISTRY }}"
          if [ -z "$REGISTRY" ]; then
            REGISTRY="ghcr.io"
          fi
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.registry.outputs.registry }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # repository owner to lowercase for Docker image naming, as devcontainers/ci does not safeguard
      - name: Get lowercase repository owner
        id: repo_owner
        run: echo "owner_lc=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
      
      # Additional gate to skip build if no devcontainer.json exists
      - name: Check devcontainer exists
        id: check
        run: |
          if [ ! -f ".devcontainer/devcontainer.json" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::No .devcontainer/devcontainer.json found, skipping build"
          else
            echo "exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Build Devcontainer Image
        uses: devcontainers/ci@v0.3
        if: steps.check.outputs.exists == 'true'
        with:
          configFile: .devcontainer/devcontainer.json
          push: never
          imageName: ${{ steps.registry.outputs.registry }}/${{ steps.repo_owner.outputs.owner_lc }}/devcontainer
          imageTag: ${{ github.ref_name }}-${{ github.sha }}
