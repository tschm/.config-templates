# This file is part of the tschm/.config-templates repository
# (https://github.com/tschm/.config-templates).
#
# Manual Release Workflow for Python Package using Hatch and
# Trusted Publisher (OIDC)
#
# This workflow implements a secure, maintainable release pipeline
# by separating concerns:
#   - ðŸ” Pre-flight checks (Tag/Release existence)
#   - ðŸ”– Tagging the release (Git tag)
#   - ðŸ—ï¸ Building the package with Hatch
#   - ðŸš€ Publishing to PyPI using OIDC (no passwords or secrets) or custom feed
#   - ðŸ“¦ Creating a GitHub Release with artifacts
#   - ðŸ³ Publishing devcontainer image (optional, if PUBLISH_DEVCONTAINER is true)
#
# Devcontainer publishing:
#   - Only occurs when PUBLISH_DEVCONTAINER repository variable is set to "true"
#   - Uses the release tag as the image tag
#   - Image is always named 'devcontainer' in the repository owner's registry
#
# ðŸ” Security:
#   - No PyPI credentials are stored; relies on Trusted Publishing via GitHub OIDC.
#   - For custom feeds, secrets are used, default username is `__token__`, which is set in action by default anyway.
#
# ðŸ“„ Requirements:
#   - `pyproject.toml` with a top-level `version = "..."`
#   - Package is registered on PyPI as a Trusted Publisher with this repository
#
# âœ… To trigger:
#   - Create and push a tag like `v1.2.3`
#   - Example: `git tag v1.2.3 && git push origin v1.2.3`

name: RELEASE

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # Needed to create releases
  id-token: write  # Needed for OIDC authentication with PyPI
  packages: write  # Needed to publish devcontainer image

jobs:
  tag:
    name: Validate Tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set_tag.outputs.tag }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Set Tag Variable
        id: set_tag
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Validate Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.set_tag.outputs.tag }}
        run: |
          if gh release view "$TAG" >/dev/null 2>&1; then
            DRAFT_STATUS=$(gh release view "$TAG" --json isDraft --jq '.isDraft')
            if [ "$DRAFT_STATUS" != "true" ]; then
              echo "::error::Release '$TAG' already exists and is not a draft. Please use a new tag."
              exit 1
            else
              echo "::warning::Release '$TAG' exists as a draft. Will proceed to update it."
            fi
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: tag
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      # Use the composite action to set up the project
      - name: Setup the project
        uses: ./.github/actions/setup-project

      - name: Verify version matches tag
        if: hashFiles('pyproject.toml') != ''
        run: |
          TAG_VERSION="${{ needs.tag.outputs.tag }}"
          TAG_VERSION=${TAG_VERSION#v}
          PROJECT_VERSION=$(uv version --short)
          
          if [[ "$PROJECT_VERSION" != "$TAG_VERSION" ]]; then
            echo "::error::Version mismatch: pyproject.toml has '$PROJECT_VERSION' but tag is '$TAG_VERSION'"
            exit 1
          fi
          echo "Version verified: $PROJECT_VERSION matches tag"

      - name: Build
        if: hashFiles('pyproject.toml') != ''
        run: |
          printf "[INFO] Building package...\n"
          uvx hatch build


      - name: Upload dist artifact
        # not tested at runtime!
        if: hashFiles('pyproject.toml') != ''
        uses: actions/upload-artifact@v5
        with:
          name: dist
          path: dist

  draft-release:
    name: Draft GitHub Release
    runs-on: ubuntu-latest
    needs: [tag, build]

    steps:
      - name: Download dist artifact
        uses: actions/download-artifact@v6
        with:
          name: dist
          path: dist
        # Fail fast if dist artifact is missing; donâ€™t create empty releases.
        # continue-on-error: true

      - name: Create GitHub Release with artifacts
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ needs.tag.outputs.tag }}
          name: ${{ needs.tag.outputs.tag }}
          generate_release_notes: true
          files: "dist/**"
          draft: true

  # Parse .env and decide at step-level whether to publish
  pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    environment: release
    needs: [tag, build, draft-release]
    outputs:
      should_publish: ${{ steps.check_dist.outputs.should_publish }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Download dist artifact
        uses: actions/download-artifact@v6
        with:
          name: dist
          path: dist
        continue-on-error: true

      - name: Check if dist contains artifacts and not marked as private
        id: check_dist
        run: |
          if [[ ! -d dist ]]; then
            echo "::warning::No folder dist/. Skipping PyPI publish."
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            if grep -R "Private :: Do Not Upload" pyproject.toml; then
              echo "should_publish=false" >> $GITHUB_OUTPUT
            else
              echo "should_publish=true" >> $GITHUB_OUTPUT
            fi
          fi
          cat $GITHUB_OUTPUT

      # this should not take place, as "Private :: Do Not Upload" set in pyproject.toml
      # repository-url and password only used for custom feeds, not for PyPI with OIDC
      - name: Publish to PyPI
        if: ${{ steps.check_dist.outputs.should_publish == 'true' }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true
          repository-url: ${{ vars.PYPI_REPOSITORY_URL }}
          password: ${{ secrets.PYPI_TOKEN }}

  devcontainer:
    name: Publish Devcontainer Image
    runs-on: ubuntu-latest
    environment: release
    needs: [tag, build, draft-release]
    outputs:
      should_publish: ${{ steps.check_publish.outputs.should_publish }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Check if devcontainer should be published
        id: check_publish
        env:
          PUBLISH_DEVCONTAINER: ${{ vars.PUBLISH_DEVCONTAINER }}
        run: |
          if [[ "$PUBLISH_DEVCONTAINER" == "true" ]] && [[ -d ".devcontainer" ]]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ Will build and publish devcontainer image"
          else
            echo "should_publish=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Skipping devcontainer publish (PUBLISH_DEVCONTAINER not true or .devcontainer missing)"
          fi

      - name: Set registry
        if: steps.check_publish.outputs.should_publish == 'true'
        id: registry
        run: |
          REGISTRY="${{ vars.DEVCONTAINER_REGISTRY }}"
          if [ -z "$REGISTRY" ]; then
            REGISTRY="ghcr.io"
          fi
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT

      - name: Login to Container Registry
        if: steps.check_publish.outputs.should_publish == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.registry.outputs.registry }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get lowercase repository owner
        if: steps.check_publish.outputs.should_publish == 'true'
        id: repo_owner
        run: echo "owner_lc=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Build and Publish Devcontainer Image
        if: steps.check_publish.outputs.should_publish == 'true'
        uses: devcontainers/ci@v0.3
        with:
          configFile: .devcontainer/devcontainer.json
          push: always
          imageName: ${{ steps.registry.outputs.registry }}/${{ steps.repo_owner.outputs.owner_lc }}/${{ github.repository }}/devcontainer
          imageTag: ${{ needs.tag.outputs.tag }}

  finalise-release:
    name: Finalise Release
    runs-on: ubuntu-latest
    needs: [tag, pypi, devcontainer]
    if: needs.pypi.result == 'success' || needs.devcontainer.result == 'success'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Generate Devcontainer Link
        id: devcontainer_link
        if: needs.devcontainer.outputs.should_publish == 'true' && needs.devcontainer.result == 'success'
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          FULL_IMAGE="ghcr.io/$OWNER_LC/devcontainer:${{ needs.tag.outputs.tag }}"
          {
            echo "message<<EOF"
            echo "### Devcontainer Image"
            echo ""
            echo "\`$FULL_IMAGE\`"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Generate PyPI Link
        id: pypi_link
        if: needs.pypi.outputs.should_publish == 'true' && needs.pypi.result == 'success'
        run: |
          PACKAGE_NAME=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['name'])")
          VERSION="${{ needs.tag.outputs.tag }}"
          VERSION=${VERSION#v}
          
          REPO_URL="${{ vars.PYPI_REPOSITORY_URL || '' }}"
          if [ -z "$REPO_URL" ]; then
             LINK="https://pypi.org/project/$PACKAGE_NAME/$VERSION/"
             NAME="PyPI Package"
          else
             LINK="$REPO_URL"
             NAME="Custom Feed Package"
          fi

          {
            echo "message<<EOF"
            echo "### $NAME"
            echo ""
            echo "[$PACKAGE_NAME]($LINK)"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Publish Release
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ needs.tag.outputs.tag }}
          draft: false
          append_body: true
          body: |
            ${{ steps.devcontainer_link.outputs.message }}
            ${{ steps.pypi_link.outputs.message }}

